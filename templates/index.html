<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life in Weeks</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container {% if has_lens %}has-lens{% endif %}"
        {% if has_lens %}
            style="--free-ratio: {{ free_ratio }};"
        {% endif %}>

        <!-- =========================
             SETUP (ALWAYS VISIBLE)
        ========================== -->
        <form method="get" class="tuner-group">
            {% if show %}
            <input type="hidden" name="show" value="true">
            <input type="hidden" name="view" value="{{ view }}">
            {% endif %}
            <div class="setup-row"
                 style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 20px;">
                <label>
                    Birthdate:
                    <input type="text"
                           class="birth-input"
                           name="birthdate"
                           value="{{ birthdate }}"
                           inputmode="numeric"
                           placeholder="19960520"
                           onchange="this.form.submit()">
                </label>

                <label>
                    Expected Lifespan:
                    <span id="lifespan-value"
                          style="color:var(--color-accent); font-weight:bold;">
                        {{ lifespan }}
                    </span>
                </label>
            </div>

            <input type="range"
                   name="lifespan"
                   min="1"
                   max="120"
                   value="{{ lifespan }}"
                   oninput="document.getElementById('lifespan-value').innerText = this.value"
                   onchange="this.form.submit()">

            <div style="margin-top: 20px;">
                <button type="submit"
                        name="show"
                        value="true"
                        class="reveal-btn">
                    Show my timeline
                </button>
            </div>

            <!-- =========================
                 LENS (ONLY AFTER REVEAL)
            ========================== -->
            {% if show %}
            <div class="daily-inputs">
                <div class="input-item">
                    <label>Sleep (hrs)</label>
                    <input type="number"
                           name="sleep"
                           class="small-input"
                           value="{{ sleep }}"
                           step="0.5"
                           min="0"
                           max="24">
                </div>

                <div class="input-item">
                    <label>Work (hrs)</label>
                    <input type="number"
                           name="work"
                           class="small-input"
                           value="{{ work }}"
                           step="0.5"
                           min="0"
                           max="24">
                </div>

                <div class="input-item">
                    <label>Commute/Chores</label>
                    <input type="number"
                           name="commute"
                           class="small-input"
                           value="{{ commute }}"
                           step="0.5"
                           min="0"
                           max="24">
                </div>
            <div class="input-item full-width" style="justify-content: flex-end; margin-left: auto;">
                <button type="submit"
                        name="show"
                        value="true"
                        class="reveal-btn"
                        style="padding: 6px 16px; font-size: 0.7rem; border-color: var(--color-accent); color: var(--color-accent);">
                    Update lens
                </button>
            </div>

            </div>

            {% if has_lens %}
            <div class="awareness-banner">
                <div class="awareness-item">
                    <span class="label">Free time per day</span>
                    <span class="value teal">{{ free_hours_per_day }} h</span>
                </div>
                <div class="awareness-item">
                    <span class="label">Free years remaining</span>
                    <span class="value teal">{{ free_years_remaining }} y</span>
                </div>
            </div>
            {% endif %}
            {% endif %}
        </form>

        <!-- =========================
             REVEAL (GATED)
        ========================== -->
        {% if show %}

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Months Lived</h3>
                <div class="value">{{ lived_months }}</div>
            </div>
            <div class="stat-card">
                <h3>Months Remaining</h3>
                <div class="value">{{ total_months - lived_months }}</div>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item"><div class="dot-sample lived"></div> Lived</div>
            <div class="legend-item"><div class="dot-sample now"></div> Present</div>
            <div class="legend-item"><div class="dot-sample remaining"></div> Remaining</div>
        </div>

        <div id="timeline-view" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
            <h2 style="margin: 0;">Life in {{ "Weeks" if view == "weeks" else "Months" }}</h2>
                            
                    <div class="view-toggle">
                        <a href="{{ url_for('home', **dict(request.args, view='weeks')) }}#timeline-view"
                        class="toggle-option {% if view == 'weeks' %}active{% endif %}">
                            Weeks
                        </a>
                        <a href="{{ url_for('home', **dict(request.args, view='months')) }}#timeline-view"
                        class="toggle-option {% if view == 'months' %}active{% endif %}">
                            Months
                        </a>
                    </div>
                </div>

                <p style="opacity:0.6; font-size:0.75rem; margin-bottom:20px;">
                    {% if has_lens %}
                        <span style="color: var(--color-accent)">Showing Available Free Time Overlay</span>
                    {% else %}
                        Each {{ "row represents year of life, shown in weeks" if view == "weeks" else "circle represents one month" }}
                    {% endif %}
                </p>

                {% if view == 'weeks' %}
                <div class="life-grid">
                    {% for year in life_map %}
                        {% set year_index = loop.index0 %}
                        <div class="year-row">
                            <span class="year-label">
                                {% if (year_index + 1) == 1 or (year_index + 1) % 5 == 0 %}
                                    {{ year_index + 1 }}
                                {% endif %}
                            </span>
                            <div class="weeks-row">
                                {% for week in year %}
                                    <div class="week {{ 'lived' if week.lived }} {{ 'current' if week.current }}"
                                        title="Year {{ year_index + 1 }}, Week {{ week.week_num }}">
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if view == 'months' %}
                <div class="months-grid">
                    {% for m in range(total_months) %}
                        <div class="month {{ 'lived' if m < lived_months }} {{ 'current' if m == current_month_idx }}"></div>
                    {% endfor %}
                </div>
                {% endif %}

        {% endif %}
    </div>
</body>
</html>
